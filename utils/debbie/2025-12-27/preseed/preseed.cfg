#_preseed_V1
#===============================================================================
# Debian 13 (Trixie) Preseed Configuration
#
# This preseed file is designed for fully automated installations.
# Validated against the official Debian trixie preseed documentation.
#
# USAGE:
#   - Embed in initrd, serve via HTTP, or include on install media
#   - Boot with: auto=true priority=critical preseed/url=http://server/preseed.cfg
#
# CUSTOMIZATION:
#   - Search for "CUSTOMIZE:" comments to find key settings to change
#   - Desktop environment section is modular - easy to swap DE
#===============================================================================

#===============================================================================
# LOCALIZATION
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-l10n
#===============================================================================

# CUSTOMIZE: Change locale/language/country as needed
# Full locale string (sets language, country, and locale together)
d-i debian-installer/locale string en_GB.UTF-8

# Alternative: Set individually for more control
#d-i debian-installer/language string en
#d-i debian-installer/country string GB
#d-i localechooser/supported-locales multiselect en_GB.UTF-8, en_US.UTF-8

# CUSTOMIZE: Keyboard layout (gb, us, de, fr, etc.)
d-i keyboard-configuration/xkb-keymap select gb
# Note: console-setup/* is deprecated, use keyboard-configuration instead

#===============================================================================
# NETWORK CONFIGURATION
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-network
#===============================================================================

# Use DHCP for network configuration (recommended for preseed)
d-i netcfg/choose_interface select auto

# CUSTOMIZE: Hostname and domain
# Note: DHCP-provided values take precedence if available
d-i netcfg/get_hostname string debian-preseed
d-i netcfg/get_domain string local

# Force hostname regardless of DHCP (uncomment if needed)
#d-i netcfg/hostname string myserver

# Disable annoying WEP key dialog
d-i netcfg/wireless_wep string

# Longer DHCP timeout for slow networks
d-i netcfg/dhcp_timeout string 60

# STATIC IP CONFIGURATION (uncomment and customize if needed)
#d-i netcfg/disable_autoconfig boolean true
#d-i netcfg/get_ipaddress string 192.168.1.100
#d-i netcfg/get_netmask string 255.255.255.0
#d-i netcfg/get_gateway string 192.168.1.1
#d-i netcfg/get_nameservers string 1.1.1.1
#d-i netcfg/confirm_static boolean true

#===============================================================================
# MIRROR SETTINGS
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-mirror
#===============================================================================

d-i mirror/country string manual
# CUSTOMIZE: Use a geographically close mirror
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# IMPORTANT: Use "trixie" for Debian 13 (not "bookworm")
d-i mirror/suite string trixie

#===============================================================================
# APT SETUP
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-apt
#===============================================================================

# Disable CD-ROM entries in sources.list (important for netinst)
d-i apt-setup/cdrom/set-first boolean false
d-i apt-setup/disable-cdrom-entries boolean true

# CUSTOMIZE: Enable non-free firmware and contrib
d-i apt-setup/non-free-firmware boolean true
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true

# Enable security and updates
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

#===============================================================================
# ACCOUNT SETUP
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-account
#===============================================================================

# CUSTOMIZE: Root account
# Option 1: Disable root, user gets sudo (recommended)
d-i passwd/root-login boolean false

# Option 2: Enable root with password (uncomment if needed)
#d-i passwd/root-login boolean true
#d-i passwd/root-password password CHANGEME
#d-i passwd/root-password-again password CHANGEME
# Or use encrypted password (generate with: mkpasswd -m sha-512)
#d-i passwd/root-password-crypted password $6$rounds=4096$...

# CUSTOMIZE: User account
d-i passwd/make-user boolean true
d-i passwd/user-fullname string Admin User
d-i passwd/username string admin

# SECURITY WARNING: Change this password!
# Plain text (not recommended for production)
d-i passwd/user-password password changeme
d-i passwd/user-password-again password changeme

# Better: Use encrypted password (generate with: mkpasswd -m sha-512)
#d-i passwd/user-password-crypted password $6$rounds=4096$...

# Allow weak passwords during automated install
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

# CUSTOMIZE: User groups
d-i passwd/user-default-groups string audio cdrom video sudo netdev

#===============================================================================
# CLOCK AND TIME ZONE
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-time
#===============================================================================

d-i clock-setup/utc boolean true
# CUSTOMIZE: Timezone (see /usr/share/zoneinfo/)
d-i time/zone string Europe/London
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string pool.ntp.org

#===============================================================================
# PARTITIONING
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-partman
#===============================================================================

# CUSTOMIZE: Partitioning method
# Options: regular, lvm, crypto (encrypted LVM)
d-i partman-auto/method string regular

# CUSTOMIZE: Partition recipe
# Options: atomic (all in one), home (separate /home), multi (separate /home, /var, /tmp)
d-i partman-auto/choose_recipe select atomic

# Automatically select the first disk (useful for VMs)
# WARNING: This will ERASE the disk
d-i partman-auto/disk string /dev/sda

# Remove existing LVM/RAID configurations
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true

# Confirm partitioning
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# UEFI/GPT Configuration (for modern systems)
# Force UEFI even if BIOS is detected
d-i partman-efi/non_efi_system boolean true
# Use GPT partition table
d-i partman-partitioning/choose_label select gpt
d-i partman-partitioning/default_label string gpt

#===============================================================================
# PACKAGE SELECTION
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-pkgsel
#===============================================================================

# CUSTOMIZE: Task selection
# Available tasks: standard, desktop, gnome-desktop, kde-desktop, xfce-desktop,
#                  cinnamon-desktop, mate-desktop, lxde-desktop, lxqt-desktop,
#                  web-server, ssh-server, laptop

#-------------------------------------------------------------------------------
# DESKTOP ENVIRONMENT CONFIGURATION
# Uncomment ONE of the following blocks based on your needs
#-------------------------------------------------------------------------------

# === OPTION 1: HEADLESS SERVER (no desktop) ===
tasksel tasksel/first multiselect standard, ssh-server

# === OPTION 2: KDE PLASMA DESKTOP ===
#tasksel tasksel/first multiselect standard, desktop, kde-desktop, ssh-server

# === OPTION 3: GNOME DESKTOP (Debian default) ===
#tasksel tasksel/first multiselect standard, desktop, gnome-desktop, ssh-server

# === OPTION 4: XFCE DESKTOP (lightweight) ===
#tasksel tasksel/first multiselect standard, desktop, xfce-desktop, ssh-server

# === OPTION 5: CINNAMON DESKTOP ===
#tasksel tasksel/first multiselect standard, desktop, cinnamon-desktop, ssh-server

# === OPTION 6: MATE DESKTOP ===
#tasksel tasksel/first multiselect standard, desktop, mate-desktop, ssh-server

# === OPTION 7: LXQT DESKTOP (very lightweight) ===
#tasksel tasksel/first multiselect standard, desktop, lxqt-desktop, ssh-server

#-------------------------------------------------------------------------------

# CUSTOMIZE: Additional packages to install
d-i pkgsel/include string openssh-server sudo vim curl wget git htop

# Upgrade packages after debootstrap
# Options: none, safe-upgrade, full-upgrade
d-i pkgsel/upgrade select full-upgrade

# Disable popularity contest
popularity-contest popularity-contest/participate boolean false

# Skip package database update (speeds up installation)
d-i pkgsel/updatedb boolean false

#===============================================================================
# BOOT LOADER (GRUB)
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-bootloader
#===============================================================================

d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean false

# CUSTOMIZE: Boot device
# "default" = first disk, or specify like "/dev/sda"
d-i grub-installer/bootdev string default

# For UEFI systems, don't install to removable media path
d-i grub-installer/force-efi-extra-removable boolean false

#===============================================================================
# FINISHING UP
# Ref: https://www.debian.org/releases/trixie/amd64/apbs04.en.html#preseed-finish
#===============================================================================

# Skip the final "installation complete" message
d-i finish-install/reboot_in_progress note

# Eject CD after installation
d-i cdrom-detect/eject boolean true

# Don't power off after installation (reboot instead)
d-i debian-installer/exit/poweroff boolean false

# Keep virtual consoles enabled (useful for debugging)
d-i finish-install/keep-consoles boolean true

#===============================================================================
# LATE COMMAND (POST-INSTALLATION SCRIPT)
# Ref: https://www.debian.org/releases/trixie/amd64/apbs05.en.html
#===============================================================================

# CUSTOMIZE: Commands to run after installation
# Use apt-install for package installation, in-target for commands in chroot

d-i preseed/late_command string \
    in-target apt-get update; \
    in-target apt-get -y dist-upgrade; \
    echo "Preseed installation completed at $(date)" > /target/root/preseed-complete.log

# Example: More complex late command with script
#d-i preseed/late_command string \
#    in-target apt-get update; \
#    in-target apt-get -y install vim htop tmux; \
#    echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /target/etc/sudoers.d/nopasswd; \
#    chmod 440 /target/etc/sudoers.d/nopasswd

#===============================================================================
# EARLY COMMAND (PRE-INSTALLATION SCRIPT)
# Runs before partitioning - useful for dynamic disk detection
#===============================================================================

# Automatically select the first available disk
#d-i partman/early_command string \
#    debconf-set partman-auto/disk "$(list-devices disk | head -n1)"

