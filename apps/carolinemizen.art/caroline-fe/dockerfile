FROM node:23-slim AS dev
WORKDIR /app
RUN corepack enable && corepack prepare yarn@4.8.1
# Note: source will be mounted via docker-compose volume
CMD ["yarn", "rsbuild", "dev", "--port", "4020"]

FROM node:23-slim AS prod-build
WORKDIR /app
RUN corepack enable && corepack prepare yarn@4.8.1

# Copy workspace root files
COPY package.json yarn.lock .yarnrc.yml ./

# Copy parent workspace package.json (carolinemizen.art defines nested workspaces)
COPY apps/carolinemizen.art/package.json ./apps/carolinemizen.art/

# Copy app package.json into workspace structure
COPY apps/carolinemizen.art/caroline-fe/package.json ./apps/carolinemizen.art/caroline-fe/

# Install workspace with lockfile (including devDependencies for build)
RUN yarn workspaces focus caroline-fe

# Copy app source and shared files
COPY apps/carolinemizen.art/caroline-fe/src ./apps/carolinemizen.art/caroline-fe/src
COPY apps/carolinemizen.art/caroline-fe/public ./apps/carolinemizen.art/caroline-fe/public
COPY apps/carolinemizen.art/caroline-fe/rsbuild.config.ts ./apps/carolinemizen.art/caroline-fe/
COPY apps/carolinemizen.art/caroline-fe/tsconfig.json ./apps/carolinemizen.art/caroline-fe/
COPY apps/carolinemizen.art/tsconfig.json ./apps/carolinemizen.art/

# Build args for environment variables
ARG API_URL=/api
ARG DEBUG_MODE=false

# Build using workspace command from root
ENV NODE_ENV=production
ENV API_URL=${API_URL}
ENV DEBUG_MODE=${DEBUG_MODE}
RUN yarn workspace caroline-fe build

FROM node:23-slim AS prod
WORKDIR /app
COPY --from=prod-build /app/apps/carolinemizen.art/caroline-fe/dist .
RUN corepack enable && corepack prepare yarn@4.8.1 && yarn global add serve
EXPOSE 4020
CMD ["serve", "-s", ".", "-l", "4020"]
