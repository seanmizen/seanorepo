FROM node:23-slim AS deps
WORKDIR /app

# Copy root package.json and .yarnrc.yml for Yarn 4 configuration
COPY package.json .yarnrc.yml ./

# Copy backend package.json and install dependencies directly
COPY apps/seanscards/backend/package.json ./package.json

# Install with yarn (standalone, not as workspace)
RUN corepack enable && corepack prepare yarn@4.8.1 && yarn install

# dev target - run source directly
FROM oven/bun:latest AS dev
WORKDIR /app/src
ENV NODE_ENV=development
CMD ["bun", "--hot", "--no-clear-screen", "index.ts"]

# prod target - run source directly (no bundling)
FROM oven/bun:latest AS prod
WORKDIR /app

# Copy application source
COPY apps/seanscards/backend ./src
COPY apps/seanscards/configs.ts ./configs.ts

# Copy node_modules from deps stage
COPY --from=deps /app/node_modules ./node_modules

ENV NODE_ENV=production
CMD ["bun", "./src/index.ts"]
